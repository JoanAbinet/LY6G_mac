---
title: "Differentiation Primed+DATP => Motro"
author: "Abinet Joan"
date: "1/30/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r cars}
suppressMessages(library(dplyr))
suppressMessages(library(Seurat))
suppressMessages(library(patchwork))
suppressMessages(library(ggplot2))
suppressMessages(library(nichenetr))
suppressMessages(library(tidyverse))
suppressMessages(library(tradeSeq))
```

# Read in NicheNet’s ligand-target prior model, ligand-receptor network and weighted integrated networks:
```{r}
ligand_target_matrix = readRDS(url("https://zenodo.org/record/3260758/files/ligand_target_matrix.rds"))
lr_network = readRDS(url("https://zenodo.org/record/3260758/files/lr_network.rds"))
weighted_networks = readRDS(url("https://zenodo.org/record/3260758/files/weighted_networks.rds"))

weighted_networks_lr = weighted_networks$lr_sig %>% inner_join(lr_network %>% distinct(from,to), by = c("from","to"))
```

## Part 1: Which are the signal released by the Eptithelial cells could causes Differentiation in Motro.

# Loading epithelial cells (senders)
```{r}
path <- "/home/qiang/Documents/Travail_cell/Travail_V3/Cécilia_project_2/Epithelial_cells/"
epithelial_cells <- readRDS(paste(path,"epithelial_cells.rds", sep = ""))

DimPlot(epithelial_cells, reduction = "umap", label = T)

DimPlot(epithelial_cells, reduction = "umap", split.by = "orig.ident")
```


# loading motro cells (receivers)
```{r}
path<-"/home/qiang/Documents/Travail_cell/Travail_V3/Cécilia_project_2/"
myeloid_cells_clustered <- readRDS(paste(path,"1PreProcessing_Clustering/Myeloid_cells_Part2.rds", sep = ""))

DimPlot(myeloid_cells_clustered, reduction = "umap", label = T)
```

# convert the NicheNet network gene symbols from human to mouse based on one-to-one orthology
```{r}
lr_network = lr_network %>% mutate(from = convert_human_to_mouse_symbols(from), to = convert_human_to_mouse_symbols(to)) %>% drop_na()
colnames(ligand_target_matrix) = ligand_target_matrix %>% colnames() %>% convert_human_to_mouse_symbols()
rownames(ligand_target_matrix) = ligand_target_matrix %>% rownames() %>% convert_human_to_mouse_symbols()

ligand_target_matrix = ligand_target_matrix %>% .[!is.na(rownames(ligand_target_matrix)), !is.na(colnames(ligand_target_matrix))]
weighted_networks_lr = weighted_networks_lr %>% mutate(from = convert_human_to_mouse_symbols(from), to = convert_human_to_mouse_symbols(to)) %>% drop_na()
```

## Performe NicheNet analysis

# 1. Define a “sender/niche” cell population and a “receiver/target” cell population in your expression data,  determine which genes are expressed in both populations

Background genes: l'ensemble des gènes exprimés par les recevers (ici ceux des clusters 3,4,1)
```{r}
## receivers
receiver_celltypes <-c("3","4","1")

#expressed_genes_receiver = get_expressed_genes("1", myeloid_cells_clustered, pct = 0.10, assay_oi = "RNA") 

# selectionne tous les gènes exprimé par au moins 10% des cellules du cluster 1.
list_expressed_genes_receiver = receiver_celltypes %>% unique() %>% lapply(get_expressed_genes, myeloid_cells_clustered, 0.10, "RNA") # lapply to get the expressed genes of every sender cell type separately here
expressed_genes_receiver = list_expressed_genes_receiver %>% unlist() %>% unique()


length(expressed_genes_receiver) # 7308 gènes sélectionner
background_expressed_genes = expressed_genes_receiver %>% .[. %in% rownames(ligand_target_matrix)]
```


```{r}
## senders
sender_celltypes <-c("2","4") # select primed AT2 et DATP

list_expressed_genes_sender = sender_celltypes %>% unique() %>% lapply(get_expressed_genes, epithelial_cells, 0.10, "RNA") # lapply to get the expressed genes of every sender cell type separately here
expressed_genes_sender = list_expressed_genes_sender %>% unlist() %>% unique()

length(expressed_genes_sender) # 7170 genes
```

# 2. Define a gene set of interest: these are the genes in the “receiver/target” cell population that are potentially affected by ligands expressed. Here tradeseq results.

Here I select 500 genes
```{r}
dir <- "/home/qiang/Documents/Travail_cell/Travail_V3/Cécilia_project_2/3.2slingshot/"
sce_slingshot <- readRDS(paste0(dir,"sce_slingshot.rds"))

diff_expression <- startVsEndTest(sce_slingshot, lineages = T, pseudotimeValues = c(0,12))

lineage2_genes<- diff_expression[order(diff_expression$waldStat_lineage2, decreasing = T),]

geneset_nichenetr <- rownames(lineage2_genes)[1:500]
```


3. Define a set of potential ligands: these are ligands that are expressed by the “sender/niche” cell population
```{r}
ligands = lr_network %>% pull(from) %>% unique()
receptors = lr_network %>% pull(to) %>% unique()

expressed_ligands = intersect(ligands,expressed_genes_sender)
expressed_receptors = intersect(receptors,expressed_genes_receiver)

potential_ligands = lr_network %>% filter(from %in% expressed_ligands & to %in% expressed_receptors) %>% pull(from) %>% unique()
```

```{r}
ligand_activities = predict_ligand_activities(geneset = geneset_nichenetr, background_expressed_genes = background_expressed_genes, ligand_target_matrix = ligand_target_matrix, potential_ligands = potential_ligands)

ligand_activities = ligand_activities %>% arrange(-pearson) %>% mutate(rank = rank(desc(pearson)))
ligand_activities
```

