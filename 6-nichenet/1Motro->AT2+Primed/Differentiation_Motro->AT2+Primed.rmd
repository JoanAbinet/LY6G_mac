---
title: "Differentiation Motro => AT2+Primed"
author: "Abinet Joan"
date: "1/27/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
suppressMessages(library(dplyr))
suppressMessages(library(Seurat))
suppressMessages(library(patchwork))
suppressMessages(library(ggplot2))
suppressMessages(library(nichenetr))
suppressMessages(library(tidyverse))
```

The first part describe the creation of a trajectory for the epithelials cells, while the second part describe the nichenet analysis between the Motro, and the AT2 + primed AT2.

# Loading epithelial cells (receivers)
```{r}
path <- "/home/qiang/Documents/Travail_cell/Travail_V3/Cécilia_project_2/Epithelial_cells/"
epithelial_cells <- readRDS(paste(path,"epithelial_cells.rds", sep = ""))

DimPlot(epithelial_cells, reduction = "umap", label = T)
```
## PART 1 : looking genes which clusters express the genes found in the analysis in nichenet_part2.rmd

# trajectory slingshot
```{r}
epithelial_cells_sub <- subset(epithelial_cells, seurat_clusters %in% c(0,1,2,3,4,5))

epithelial_cells_sub <- RunUMAP (epithelial_cells_sub , dims = 1:15)
DimPlot(epithelial_cells_sub, reduction = "umap", label = T)

# il y a des cellules qui trouble la création d'une trajectoires car complètement isolée des autres.
# faut les identifier et les retirer

# identifier les cellules par rapport à leur position dans la umap
umap_coordinate<- epithelial_cells_sub@reductions$umap@cell.embeddings
# les cellules à retirer ont des coordonnées supérieur à 10 sur la umap_1
View(umap_coordinate[order(umap_coordinate[,1], decreasing = T)])
     
cells_to_remove<- c("2_CTAACTTCAACTGGCC-1", "2_GTCACAAGTGTGAAAT-1", "3_GCAAACTTCTTGCATT-1", "2_CTGCGGAGTCGCGGTT-1", "1_CCTATTACAAGACGTG-1", "2_GGCTGGTAGAGCTATA-1", "1_GGTGAAGAGCCTTGAT-1", "1_TATCAGGCATATGGTC-1", "3_GGAGCAATCTGTACGA-1", "2_AGCTTGATCCAAACAC-1", "3_CGAGAAGCATTGAGCT-1", "1_GTCGGGTCAATCTACG-1", "3_CTGTTTAAGCTTTGGT-1", "1_GTACGTAAGCGTTCCG-1", "1_GTTTCTAGTCTCTTTA-1", "3_CGAGAAGCATGTCTCC-1", 
"1_ATCATCTCACGCGAAA-1")

epithelial_cells_sub <- subset(epithelial_cells_sub, cells = cells_to_remove, invert= T)

DimPlot(epithelial_cells_sub, reduction = "umap", label = T)
```

```{r}
p <- Embeddings(epithelial_cells_sub, "umap")

sds <- slingshot(Embeddings(epithelial_cells_sub, "umap"), epithelial_cells_sub$seurat_clusters, start.clus = 3)
# the two step of slingshot can be run separately using getlineages and getcurves

epithelial_cells_sub$color <- epithelial_cells_sub$seurat_clusters
levels(epithelial_cells_sub$color) <-c( "#F8766D","#C49A00","#53B400","#00C094","#00B6EB","#A58AFF","#FB61D7")

plot(reducedDim(sds), col = as.vector(epithelial_cells_sub$color), pch = 16, cex = 0.5)
lines(sds, lwd = 2 , col = 'black')
```

```{r}
library(viridisLite)
nc <- 3
pt <- slingPseudotime(sds)
nms <- colnames(pt)
nr <- ceiling(length(nms)/nc)
pal <- viridis(100, end = 0.95)
par(mfrow = c(nr, nc))
for (i in nms) {
  colors <- pal[cut(pt[,i], breaks = 100)]
  plot(reducedDim(sds), col = colors, pch = 16, cex = 0.5, main = i)
  lines(sds, lwd = 2, col = 'black')
}

```

## launching tradeseq

```{r}
CountMat <- epithelial_cells_sub@assays$RNA@counts

icMat <- evaluateK(counts = CountMat, sds = sds, k = 3:10, 
                   nGenes = 200, verbose = T)

```

```{r}
pseudotime <- slingPseudotime(sds, na = FALSE)
cellWeights <- slingCurveWeights(sds)

sce_slingshot <- fitGAM(counts = CountMat, pseudotime = pseudotime, cellWeights = cellWeights)

saveRDS(sce_slingshot, "sce_epithelial.rds")
```

Attention ici je recherche les gènes cibles de l'étapes d'avant (Motro vers ensemble des cellules épith)
```{r}
gene_list <- c("Ahnak","Atf3", "Bax", "Brd2","Cav1", "Ccnd1", "Ccnd2", "Cdkn1a", "Cebpb", "Cirbp", "Cited2", "Clic1",   "Ddit3", "Ddit4", "Dusp1", "Eif5a","Etfb","Gadd45b","Gapdh","Gdf15","Gsn","Hmox1","Hsp90ab1","Icam1" ,"Id2", "Id3" ,"Ier3","Junb","Krt8","Lmna","Mdm2","Nav2","Nfe2l2","Nfkbia", "Ptma","S100a10","Sema3b","Socs3","Tgif1" ,"Timp2", "Trp53" ,"Vegfa","Ager","Cd36","Ranbp1","Scd1","Sftpa1","Zbtb20","Fasn","Hsp90aa1","Hspa1a","Hspa8","Hspb1", "Sqstm1"  , "Fosb","Ier5","Sptbn1","Cald1","Calr","Cdkn2b","Col4a1", "Cryab","Fkbp1a","Glrx","Gsto1","Itgb1","Krt18" ,"Mettl7a1", "Pdgfa", "Plaur", "Serpine2", "Trf" ,"Gadd45a", "Lcn2", "Slc3a2", "Tpm1", "Anxa2", "Ndst1", "Sdc4",  "Btg2", "Ang","Cd44","Chil1","Clu","Ctnna1","Itgav","Msn","Nr4a1","Nrp1","Pdpn" ,"Sparc" ,"Tnfrsf12a")
```

```{r}
for (sigGene in gene_list) {
  plotSmoothers(sce_slingshot, counts = counts(sce_slingshot), gene = sigGene) + ggtitle (sigGene)
  ggsave(paste("plotSmoothers/",sigGene,".png", sep = ""))
  FeaturePlot(epithelial_cells, features = sigGene )
  ggsave(paste("FeaturePlot/",sigGene,".png", sep = ""))
}
```

```{r}
sigGene <- "Pdpn"
plotSmoothers(sce_slingshot, counts = counts(sce_slingshot), gene = sigGene) + ggtitle (sigGene)
```


## PART 2 : Nichenet sur un subset des cellules epitheliales
# loading motro cells (Senders)
```{r}
path<-"/home/qiang/Documents/Travail_cell/Travail_V3/Cécilia_project_2/"
myeloid_cells_clustered <- readRDS(paste(path,"1PreProcessing_Clustering/Myeloid_cells_Part2.rds", sep = ""))

DimPlot(myeloid_cells_clustered, reduction = "umap", label = T, group.by = "CellType")
#ggsave("plot_Part2/Umap_myeloid_cells.png", height = 7, width = 12)

DefaultAssay(myeloid_cells_clustered) <- "RNA" # important
```


##
```{r}
ligand_target_matrix = readRDS(url("https://zenodo.org/record/3260758/files/ligand_target_matrix.rds"))
lr_network = readRDS(url("https://zenodo.org/record/3260758/files/lr_network.rds"))
weighted_networks = readRDS(url("https://zenodo.org/record/3260758/files/weighted_networks.rds"))

weighted_networks_lr = weighted_networks$lr_sig %>% inner_join(lr_network %>% distinct(from,to), by = c("from","to"))
```

```{r}
lr_network = lr_network %>% mutate(from = convert_human_to_mouse_symbols(from), to = convert_human_to_mouse_symbols(to)) %>% drop_na()
colnames(ligand_target_matrix) = ligand_target_matrix %>% colnames() %>% convert_human_to_mouse_symbols()
rownames(ligand_target_matrix) = ligand_target_matrix %>% rownames() %>% convert_human_to_mouse_symbols()

ligand_target_matrix = ligand_target_matrix %>% .[!is.na(rownames(ligand_target_matrix)), !is.na(colnames(ligand_target_matrix))]
weighted_networks_lr = weighted_networks_lr %>% mutate(from = convert_human_to_mouse_symbols(from), to = convert_human_to_mouse_symbols(to)) %>% drop_na()
```



# Background genes: l'ensemble des gènes exprimés par les recevers (ici ceux des clusters 3,4,1)
```{r}
## receivers
receiver_celltypes <-c("0","1","2","3")

# select all genes expressed by at least 10% of the cells.
list_expressed_genes_receiver = receiver_celltypes %>% unique() %>% lapply(get_expressed_genes, epithelial_cells, 0.10, "RNA") # lapply to get the expressed genes of every sender cell type separately here
expressed_genes_receiver = list_expressed_genes_receiver %>% unlist() %>% unique()

length(expressed_genes_receiver) # 6760 gènes sélectionner
background_expressed_genes = expressed_genes_receiver %>% .[. %in% rownames(ligand_target_matrix)]
```


# Senders genes
```{r}
## senders
sender_celltype <-"1" # select cluster 1.

expressed_genes_sender = get_expressed_genes(sender_celltype, myeloid_cells_clustered, pct = 0.10, "RNA")

length(expressed_genes_sender)# 6871 genes
```

```{r}
DE_AT2vPrimed = FindMarkers(object = epithelial_cells, ident.1 = c(0,1,3), ident.2 = 2, min.pct = 0.10) %>% rownames_to_column("gene")
DE_AT2vPrimed <- DE_AT2vPrimed[order(abs(DE_AT2vPrimed$avg_log2FC), decreasing = T),]

geneset <- c(DE_AT2vPrimed$gene[1:500])# tous les gènes avec un avg_log2FC supérieur ou inférieur à 0.3. J'observe peu de différence entre les gènes AT2 et les primed AT2
geneset <- unique(geneset)
length(geneset) 
```


```{r}
ligands = lr_network %>% pull(from) %>% unique()
receptors = lr_network %>% pull(to) %>% unique()

expressed_ligands = intersect(ligands,expressed_genes_sender)
expressed_receptors = intersect(receptors,expressed_genes_receiver)

potential_ligands = lr_network %>% filter(from %in% expressed_ligands & to %in% expressed_receptors) %>% pull(from) %>% unique()
```

```{r}
ligand_activities = predict_ligand_activities(geneset = geneset, background_expressed_genes = background_expressed_genes, ligand_target_matrix = ligand_target_matrix, potential_ligands = potential_ligands)

ligand_activities = ligand_activities %>% arrange(-pearson) %>% mutate(rank = rank(desc(pearson)))
ligand_activities
```
```{r}
old_ligand
```


```{r}
best_upstream_ligands = ligand_activities %>% top_n(20, pearson) %>% arrange(-pearson) %>% pull(test_ligand) %>% unique()
```
```{r}
DotPlot(myeloid_cells_clustered, features = best_upstream_ligands %>% rev(), cols = "RdYlBu", group.by = "CellType") + RotatedAxis()
```

# Find the target genes influence by the ligands
```{r}
# find the weight of the link that associate the possible ligands and the gene in the geneset
active_ligand_target_links_df = best_upstream_ligands %>% lapply(get_weighted_ligand_target_links,geneset = geneset, ligand_target_matrix = ligand_target_matrix, n = 200) %>% bind_rows() %>% drop_na()

# create a tibble desbring the data in active_ligand_target_links_df
active_ligand_target_links = prepare_ligand_target_visualization(ligand_target_df = active_ligand_target_links_df, ligand_target_matrix = ligand_target_matrix, cutoff = 0.33)

#
order_ligands = intersect(best_upstream_ligands, colnames(active_ligand_target_links)) %>% rev() %>% make.names()
order_targets = active_ligand_target_links_df$target %>% unique() %>% intersect(rownames(active_ligand_target_links)) %>% make.names()
rownames(active_ligand_target_links) = rownames(active_ligand_target_links) %>% make.names() # make.names() for heatmap visualization of genes like H2-T23
colnames(active_ligand_target_links) = colnames(active_ligand_target_links) %>% make.names() # make.names() for heatmap visualization of genes like H2-T23

vis_ligand_target = active_ligand_target_links[order_targets,order_ligands] %>% t()
```

```{r}
p_ligand_target_network = vis_ligand_target %>% make_heatmap_ggplot("Prioritized ligands","Predicted target genes", color = "purple",legend_position = "top", x_axis_position = "top",legend_title = "Regulatory potential")  + theme(axis.text.x = element_text(face = "italic")) + scale_fill_gradient2(low = "whitesmoke",  high = "purple", breaks = c(0,0.0045,0.0090))

p_ligand_target_network
```

# Display the receptor
```{r}
lr_network_top = lr_network %>% filter(from %in% best_upstream_ligands & to %in% expressed_receptors) %>% distinct(from,to)
best_upstream_receptors = lr_network_top %>% pull(to) %>% unique()

lr_network_top_df_large = weighted_networks_lr %>% filter(from %in% best_upstream_ligands & to %in% best_upstream_receptors)

lr_network_top_df = lr_network_top_df_large %>% spread("from","weight",fill = 0)
lr_network_top_matrix = lr_network_top_df %>% dplyr::select(-to) %>% as.matrix() %>% magrittr::set_rownames(lr_network_top_df$to)

dist_receptors = dist(lr_network_top_matrix, method = "binary")
hclust_receptors = hclust(dist_receptors, method = "ward.D2")
order_receptors = hclust_receptors$labels[hclust_receptors$order]
    
dist_ligands = dist(lr_network_top_matrix %>% t(), method = "binary")
hclust_ligands = hclust(dist_ligands, method = "ward.D2")
order_ligands_receptor = hclust_ligands$labels[hclust_ligands$order]

order_receptors = order_receptors %>% intersect(rownames(lr_network_top_matrix))
order_ligands_receptor = order_ligands_receptor %>% intersect(colnames(lr_network_top_matrix))

vis_ligand_receptor_network = lr_network_top_matrix[order_receptors, order_ligands_receptor]
rownames(vis_ligand_receptor_network) = order_receptors %>% make.names()
colnames(vis_ligand_receptor_network) = order_ligands_receptor %>% make.names()
```

```{r}
p_ligand_receptor_network = vis_ligand_receptor_network %>% t() %>% make_heatmap_ggplot("Ligands","Receptors", color = "mediumvioletred", x_axis_position = "top",legend_title = "Prior interaction potential")
p_ligand_receptor_network
```

# Bona-fide interaction
```{r}
lr_network_strict = lr_network %>% filter(database != "ppi_prediction_go" & database != "ppi_prediction")
ligands_bona_fide = lr_network_strict %>% pull(from) %>% unique()
receptors_bona_fide = lr_network_strict %>% pull(to) %>% unique()

lr_network_top_df_large_strict = lr_network_top_df_large %>% distinct(from,to) %>% inner_join(lr_network_strict, by = c("from","to")) %>% distinct(from,to)
lr_network_top_df_large_strict = lr_network_top_df_large_strict %>% inner_join(lr_network_top_df_large, by = c("from","to"))

lr_network_top_df_strict = lr_network_top_df_large_strict %>% spread("from","weight",fill = 0)
lr_network_top_matrix_strict = lr_network_top_df_strict %>% select(-to) %>% as.matrix() %>% magrittr::set_rownames(lr_network_top_df_strict$to)

dist_receptors = dist(lr_network_top_matrix_strict, method = "binary")
hclust_receptors = hclust(dist_receptors, method = "ward.D2")
order_receptors = hclust_receptors$labels[hclust_receptors$order]

dist_ligands = dist(lr_network_top_matrix_strict %>% t(), method = "binary")
hclust_ligands = hclust(dist_ligands, method = "ward.D2")
order_ligands_receptor = hclust_ligands$labels[hclust_ligands$order]

order_receptors = order_receptors %>% intersect(rownames(lr_network_top_matrix_strict))
order_ligands_receptor = order_ligands_receptor %>% intersect(colnames(lr_network_top_matrix_strict))

vis_ligand_receptor_network_strict = lr_network_top_matrix_strict[order_receptors, order_ligands_receptor]
rownames(vis_ligand_receptor_network_strict) = order_receptors %>% make.names()
colnames(vis_ligand_receptor_network_strict) = order_ligands_receptor %>% make.names()
```

```{r}
p_ligand_receptor_network_strict = vis_ligand_receptor_network_strict %>% t() %>% make_heatmap_ggplot("Ligands","Receptors", color = "mediumvioletred", x_axis_position = "top",legend_title = "Prior interaction potential\n(bona fide)")
p_ligand_receptor_network_strict
```



# Measuring ligand activity
```{r}
# ligand activity heatmap
ligand_pearson_matrix = ligand_activities %>% dplyr::select(pearson) %>% as.matrix() %>% magrittr::set_rownames(ligand_activities$test_ligand)

rownames(ligand_pearson_matrix) = rownames(ligand_pearson_matrix) %>% make.names()
colnames(ligand_pearson_matrix) = colnames(ligand_pearson_matrix) %>% make.names()

vis_ligand_pearson = ligand_pearson_matrix[order_ligands, ] %>% as.matrix(ncol = 1) %>% magrittr::set_colnames("Pearson")
p_ligand_pearson = vis_ligand_pearson %>% make_heatmap_ggplot("Prioritized ligands","Ligand activity", color = "darkorange",legend_position = "top", x_axis_position = "top", legend_title = "Pearson correlation coefficient\ntarget gene prediction ability)") + theme(legend.text = element_text(size = 9))

p_ligand_pearson
```
seurat_clusters
```{r}
epithelial_cells_sub <- subset(epithelial_cells, seurat_clusters %in% c(0,1,2,3))
DimPlot(epithelial_cells_sub, reduction = "umap", label = T)
```


## Generating a circos-plot

```{r}
active_ligand_target_links_df = best_upstream_ligands %>% lapply(get_weighted_ligand_target_links,geneset = geneset, ligand_target_matrix = ligand_target_matrix, n = 250) %>% bind_rows()

active_ligand_target_links_df = active_ligand_target_links_df %>% mutate(target_type = "p_emt") %>% inner_join(ligand_type_indication_df)
```

