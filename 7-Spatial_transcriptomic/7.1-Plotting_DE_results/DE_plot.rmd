---
title: "Plot from Differencial expression"
author: "Abinet Joan"
date: "`r format (Sys.time(), format='%Y-%m-%d %H:%M:%S %z')`"
output:
  pdf_document:  
    toc: true
    toc_depth: 2
  html_document: default
header-includes:
  - |
    ```{=latex}
    \usepackage{fvextra}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{
      breaksymbolleft={}, 
      showspaces = false,
      showtabs = false,
      breaklines,
      commandchars=\\\{\}
    }
    ```
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading packages
```{r}
suppressMessages(library(readxl))
suppressMessages(library(tidyr))
suppressMessages(library(ggplot2))
suppressMessages(library(dplyr))
suppressMessages(library(EnhancedVolcano))
suppressMessages(library(ComplexHeatmap))
suppressMessages(library(formatR))
```

# Loading the annotation file from Q3 - publications
```{r}
colData <- read_excel("../Data_DSPDA/Q3 - publication - V2.xlsx", sheet = "SegmentProperties")
colData <- as.data.frame(colData)
rownames(colData) <- colData$SegmentDisplayName

# Annotation table for Heatmap
df <- as.data.frame(colData[,c("SlideName","Group")])
```

# Loading the normalised count matrix
```{r}
Q3_publication <- read_excel("../Data_DSPDA/Q3 - publication - V2.xlsx", sheet = "TargetCountMatrix")
Q3_publication <- as.data.frame(Q3_publication)
rownames(Q3_publication) <- Q3_publication$TargetName
Q3_publication$TargetName <- NULL

rld <- log2(Q3_publication)
```

# Plotting DE results

##  Perilesional vs intralesional
```{r fig.width=8, fig.height=8}
DE_perivsintra <- read_excel("Data/DE_Intra-vs-Peri-V2.xlsx", sheet = "VolcanoPlot", range = "C7:H19969")

DE_perivsintra$padj <- as.numeric(DE_perivsintra$`Adjusted pvalue`)

EnhancedVolcano(DE_perivsintra, DE_perivsintra$`Target name`, x = "Log2", y = "padj", title= "DE-perilesional vs intralesional", FCcutoff = 1, pCutoff = 0.05, labSize = 0.1, ylim = c(0,4), xlim = c(-5.5,3), gridlines.major= F, gridlines.minor = F)
#ggsave("volcanoplot/Volcano_perivsintraV2.pdf", width = 10, height = 10)
```


## Extralesional vs intralesionnal
Unaffected correspond to extralesional
```{r fig.width=8, fig.height=8}
DE_UnaffectedvsIntra <- read_excel("Data/DE-Intra-vs-Unaffected-V2.xlsx", sheet = "VolcanoPlot", range = "C7:H19969")
DE_UnaffectedvsIntra$padj <- as.numeric(DE_UnaffectedvsIntra$`Adjusted pvalue`)

EnhancedVolcano(DE_UnaffectedvsIntra, DE_UnaffectedvsIntra$`Target name`, x = "Log2", y = "padj", title= "DE-extralesional vs intralesionnal", FCcutoff = 1, pCutoff = 0.05, labSize = 0.1, ylim = c(0,4), xlim = c(-5.5,3), gridlines.major= F, gridlines.minor = F)

#ggsave("volcanoplot/Volcano_UnaffectedvsIntraV2.pdf", width = 10, height = 10)
```


## Extralesional vs perilesional
```{r fig.width=8, fig.height=8}
# Loading results from DE
DE_UnaffectedvsPeri <- read_excel("Data/DE-Peri-vs-Unaffected-V2.xlsx", sheet = "VolcanoPlot", range = "C7:H19969")
DE_UnaffectedvsPeri$padj <- as.numeric(DE_UnaffectedvsPeri$`Adjusted pvalue`)

EnhancedVolcano(DE_UnaffectedvsPeri, DE_UnaffectedvsPeri$`Target name`, x = "Log2", y = "padj", title= "DE-extralesional vs perilesional", FCcutoff = 1, pCutoff = 0.05, labSize = 0.1, ylim = c(0,4), xlim = c(-5.5,3), gridlines.major= F, gridlines.minor = F)
#ggsave("volcanoplot/Volcano_UnaffectedvsPeri.pdf", width = 10, height = 10)
```

## Unaffected vs Healthy Control
```{r fig.width=8, fig.height=6}
DE_UnaffectedvsHealthy <- read_excel("Data/DE-Unaffected-vs-Healthy-V2.xlsx", sheet = "VolcanoPlot", range = "C7:H19969")
DE_UnaffectedvsHealthy$padj <- as.numeric(DE_UnaffectedvsHealthy$`Adjusted pvalue`)

EnhancedVolcano(DE_UnaffectedvsHealthy, DE_UnaffectedvsHealthy$`Target name`, x = "Log2", y = "padj", title= "DE-unaffected vs Control", FCcutoff = 1, pCutoff = 0.05, labSize = 0.1, ylim = c(0,4), gridlines.major= F, gridlines.minor = F)
#ggsave("volcanoplot/Volcano_UnaffectedvsHealthy.pdf", width = 15, height = 15)
```

## Perilesional vs Healthy Control
```{r fig.width=8, fig.height=8}
DE_HealthyvsPeri <- read_excel("Data/DE_Peri-vs-Healthy-V2.xlsx", sheet = "VolcanoPlot", range = "C7:H19969")
DE_HealthyvsPeri$padj <- as.numeric(DE_HealthyvsPeri$`Adjusted pvalue`)

EnhancedVolcano(DE_HealthyvsPeri, DE_HealthyvsPeri$`Target name`, x = "Log2", y = "padj", title= "DE- Peri vs Control", FCcutoff = 1, pCutoff = 0.05, labSize = 0.1, ylim = c(0,10), xlim = c(-5.5,5), gridlines.major= F, gridlines.minor = F)
#ggsave("volcanoplot/Volcano_DE_HealthyvsPeriV2.pdf", width = 10, height = 10)
```

# Heatmap of 522 genes upregulated in perilesional areas
```{r, message=FALSE, warning=FALSE, results= "hide"}
DE_522genes <- read_excel("Data/522-genes-UP-peri-Heatmap.xlsx", sheet = "Dendrogram", range = "C5:AA532", col_names = F)
DE_522genes <- DE_522genes[-c(3,4),] 
sample_name <- paste(DE_522genes[1,], DE_522genes[2,],DE_522genes[3,], sep="|")

colnames(DE_522genes) <- c("Target Name", sample_name[-1])
DE_522genes <- DE_522genes[-c(1,2,3,4),] 
DE_522genes <- as.data.frame(DE_522genes)

rownames(DE_522genes) <- DE_522genes[,1]
DE_522genes <- DE_522genes[,-1]

# convert data to numeric matrix
DE522genes_num <- apply(DE_522genes,2, as.numeric)
rownames(DE522genes_num) <- rownames(DE_522genes)
colnames(DE522genes_num) <- colnames(DE_522genes)
```

```{r, message=FALSE, warning=FALSE, results= "hide"}
color_df <- list(Group = 
                   c("Healthy" = "gray",
                     "Intralesional" = "yellow",
                     "Perilesional" = "orange",
                     "Unaffected" = "white"))

rownames(df) <- gsub(" ", "", rownames(df))
df <- df[c(15,24,6,11,10,14,7,8,16,4,2,3,13,17,1,5,19,18,21,20,22,9,12,23),]

modified_vector <- substring(rownames(df), 1, nchar(rownames(df)) - 3)  # Extract all but last 3 characters
rownames(df) <- paste(modified_vector, substring(rownames(df), nchar(rownames(df)) - 2), sep = " ")  # Concatenate with last 3 characters separated by a space

# verify that the 2 vector are the same
setequal(rownames(df),colnames(DE522genes_num))
```

```{r fig.width=6, fig.height=10}
Heatmap_522genes <- Heatmap(t(scale(t(DE522genes_num))), cluster_columns = T,
                    top_annotation = HeatmapAnnotation(df = df, col = color_df),
                    cluster_rows = T,
                    show_row_names = F,
                    row_names_gp = gpar(fontsize = 2),
                    column_names_gp = gpar(fontsize = 6))
                    
Heatmap_522genes
#tidyHeatmap::save_pdf(Heatmap_522genes, "522-genes-UP-peri-Heatmap.pdf", width = 15, height = 50, units = "cm")
```


```{r}
sessionInfo()
```

