---
title: "Scoring cells CLEAN"
author: "Abinet Joan"
date: "`r format (Sys.time(), format='%Y-%m-%d %H:%M:%S %z')`"
output:
  pdf_document: default
  html_document: default
header-includes:
  - |
    ```{=latex}
    \usepackage{fvextra}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{
      breaksymbolleft={}, 
      showspaces = false,
      showtabs = false,
      breaklines,
      commandchars=\\\{\}
    }
    ```
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# This code is supposed to be a cleaner version of "scoring_cells.rmd"
```{r}
suppressMessages(library(dplyr))
suppressMessages(library(patchwork))
suppressMessages(library(ggplot2))
suppressMessages(library(DESeq2))
suppressMessages(library(readxl))
suppressMessages(library("pheatmap"))
suppressMessages(library("RColorBrewer"))
suppressMessages(library(singscore))
suppressMessages(library(GSEABase))
```


# Loading transptomic spatial data and generating deseq2 object
```{r pressure, echo=FALSE}
setwd("~/Documents/Travail_cell/Travail_V3/Project_cecilia/Transcriptomique_spatiale/Info_sample+data")

countData <- read_excel("All Data WTA.xlsx", sheet = "Q3")
countData <- as.data.frame(countData)

# get gene name as row name
rownames(countData) <- countData$TargetName
countData <- countData[,-1]
# Arrondir les valeurs car nécessite des int
countData <- round(countData)


colData <- read.table("reference_sample.txt", header= T, sep = ",")
# transforme les noms de rangé de colData
rownames(colData) <- colData[,1]

dds_Q3 <- DESeqDataSetFromMatrix(countData = countData, colData = colData, design = ~ Slice + Analyse_DE)

dds_Q3 <- suppressMessages(DESeq(dds_Q3))
rlogQ3<- suppressMessages(rlog(dds_Q3))
```

# load function from GetSignatureScore
```{r}
source("GetSignatureScore.R")
```

# function to display score in a barplot
```{r}
visualise_score <- function(features.scores.use) {

  data_plot <- cbind(colData(dds_Q3),as.vector(features.scores.use))
  data_plot <- data_plot[order(data_plot$Position),]
  
  barplot(data_plot$`as.vector(features.scores.use)`,
          col = c(rep("orange",2), rep("red",2) , rep("green",4), rep("cyan",6) ,rep("blue",8), rep("pink",2)),
          
          names.arg = c("1_1","2_1","1_2","2_2","1_6","1_9","2_3","2_8","1_3","1_5","1_8","2_12", "2_4", "2_5", "1_10", "1_11", "1_4", "1_7", "2_10", "2_11", "2_6", "2_7", "1_12", "2_9"),
        
          cex.names = 0.3
  )
}
```


# Get score Motro
```{r}
Motro_DE <- read.csv("/home/qiang/Documents/Travail_cell/Travail_V3/Project_cecilia/4GO_Scenic/signature_motro_DE.csv")
Motro_DE <- Motro_DE[order(Motro_DE$avg_log2FC, decreasing = T),]
Top20_Motro <- Motro_DE$X[1:20]

features.scores.use <- GetSignatureScore(dds_Q3, Top20_Motro)
new_row <- c("Motro", features.scores.use)

visualise_score(features.scores.use)
```

# Dataframe
```{r}
Norm_exprMat <- countData
```


# get score with singscore
```{r}
#Norm_exprMat <- assay(rlogQ3)

rankData <- rankGenes(Norm_exprMat)

scoredf <- simpleScore(rankData, upSet = Top20_Motro)

scoredf <- cbind(colData(rlogQ3)$Position,scoredf)
scoredf <- scoredf[order(scoredf$`colData(rlogQ3)$Position`),]

bp <- barplot(scoredf$TotalScore,
        col = c(rep("orange",2), rep("red",2) , rep("green",4), rep("cyan",6) ,rep("blue",8), rep("pink",2)),
        
        names.arg = c("1_1","2_1","1_2","2_2","1_6","1_9","2_3","2_8","1_3","1_5","1_8","2_12", "2_4", "2_5", "1_10", "1_11", "1_4", "1_7", "2_10", "2_11", "2_6", "2_7", "1_12", "2_9"), ylim = c(0,0.5)
)
grid(nx=NA, ny=NULL)
abline(v = bp+0.6, lty=2, col = "gray")
```


```{r}
Motro_DE <- read.csv("/home/qiang/Documents/Travail_cell/Travail_V3/Project_cecilia/4GO_Scenic/signature_motro_DE.csv")
Motro_DE <- Motro_DE[order(Motro_DE$avg_log2FC, decreasing = T),]
Top20_Motro <- Motro_DE$X[1:20]

#Norm_exprMat <- counts(dds_Q3, normalized=T)

rankData <- rankGenes(Norm_exprMat)

scoredf <- simpleScore(rankData, upSet = Top20_Motro)
new_row <- c("Motro", scoredf$TotalScore)

scoredf <- cbind(colData(rlogQ3)$Position,scoredf)
scoredf <- scoredf[order(scoredf$`colData(rlogQ3)$Position`),]

barplot(scoredf$TotalScore,
        col = c(rep("orange",2), rep("red",2) , rep("green",4), rep("cyan",6) ,rep("blue",8), rep("pink",2)),
        
        names.arg = c("1_1","2_1","1_2","2_2","1_6","1_9","2_3","2_8","1_3","1_5","1_8","2_12", "2_4", "2_5", "1_10", "1_11", "1_4", "1_7", "2_10", "2_11", "2_6", "2_7", "1_12", "2_9"), ylim = c(0,0.5),
        cex.names = 0.3
)
grid(nx=NA, ny=NULL)

```

# Dataframe singscore
```{r}
cell_singscore <- data.frame(new_row)
```


# Get score AM
```{r}
myeloid.markers <- read.csv("/home/qiang/Documents/Travail_cell/Travail_V3/Cécilia_project_2/1.2Visualise_feature/myeloids_markers_top20.csv")

myeloid.markers_AM <- myeloid.markers[myeloid.markers$cluster == 5,]$gene

# Ear2 and Kcnq1ot1 are not in the expression data 
myeloid.markers_AM <- myeloid.markers_AM[-c(7,13)]


features.scores.use <- GetSignatureScore(dds_Q3, myeloid.markers_AM)
new_row <- c("AM", features.scores.use)
#cell_score <- cbind(cell_score, new_row)


visualise_score(features.scores.use)
```

```{r}
#Norm_exprMat <- counts(dds_Q3, normalized=T)
#Norm_exprMat <- assay(rlogQ3)

rankData <- rankGenes(Norm_exprMat)

scoredf <- simpleScore(rankData, upSet = myeloid.markers_AM)
new_row <- c("AM", scoredf$TotalScore)
#cell_singscore <- cbind(cell_singscore, new_row)


scoredf <- cbind(colData(rlogQ3)$Position,scoredf)
scoredf <- scoredf[order(scoredf$`colData(rlogQ3)$Position`),]

barplot(scoredf$TotalScore,
        col = c(rep("orange",2), rep("red",2) , rep("green",4), rep("cyan",6) ,rep("blue",8), rep("pink",2)),
        
        names.arg = c("1_1","2_1","1_2","2_2","1_6","1_9","2_3","2_8","1_3","1_5","1_8","2_12", "2_4", "2_5", "1_10", "1_11", "1_4", "1_7", "2_10", "2_11", "2_6", "2_7", "1_12", "2_9"), cex.names = 0.3
)
grid(nx=NA, ny=NULL)
abline(v = bp+0.6, lty=2, col = "gray")


```

# score neutro
```{r}
myeloid.markers <- read.csv("/home/qiang/Documents/Travail_cell/Travail_V3/Cécilia_project_2/1.2Visualise_feature/myeloids_markers_top20.csv")

myeloid.markers_neut <- myeloid.markers[myeloid.markers$cluster == 6,]$gene

# Stfa2l1 and Cstdc4 are not in the expression data 
myeloid.markers_neut <- myeloid.markers_neut[-c(5,8)]

features.scores.use <- GetSignatureScore(dds_Q3, myeloid.markers_neut)
new_row <- c("Neutro", features.scores.use)
cell_score <- cbind(cell_score, new_row)


visualise_score(features.scores.use)

which(rownames(Norm_exprMat) ==  "Slc7a11" )
```


```{r}
#Norm_exprMat <- counts(dds_Q3, normalized=T)
#Norm_exprMat <- assay(rlogQ3)

rankData <- rankGenes(Norm_exprMat)

scoredf <- simpleScore(rankData, upSet = myeloid.markers_neut)
new_row <- c("Neutro", scoredf$TotalScore)
#cell_singscore <- cbind(cell_singscore, new_row)


scoredf <- cbind(colData(rlogQ3)$Position,scoredf)
scoredf <- scoredf[order(scoredf$`colData(rlogQ3)$Position`),]

barplot(scoredf$TotalScore,
        col = c(rep("orange",2), rep("red",2) , rep("green",4), rep("cyan",6) ,rep("blue",8), rep("pink",2)),
        
        names.arg = c("1_1","2_1","1_2","2_2","1_6","1_9","2_3","2_8","1_3","1_5","1_8","2_12", "2_4", "2_5", "1_10", "1_11", "1_4", "1_7", "2_10", "2_11", "2_6", "2_7", "1_12", "2_9"), cex.names = 0.3
)
grid(nx=NA, ny=NULL)
abline(v = bp+0.6, lty=2, col = "gray")

```



# score cd64
```{r}
myeloid.markers <- read.csv("/home/qiang/Documents/Travail_cell/Travail_V3/Cécilia_project_2/1.2Visualise_feature/myeloids_markers_top20.csv")

myeloid.markers_cd64 <- myeloid.markers[myeloid.markers$cluster == 4,]$gene

# Ly6c2 and Ifi204 are not in the expression data 
myeloid.markers_cd64 <- myeloid.markers_cd64[-c(2,12)]


features.scores.use <- GetSignatureScore(dds_Q3, myeloid.markers_cd64)
new_row <- c("cd64", features.scores.use)
#cell_score <- cbind(cell_score, new_row)


visualise_score(features.scores.use)

which(rownames(Norm_exprMat) ==  "Ms4a6d" )
```

```{r}
#Norm_exprMat <- counts(dds_Q3, normalized=T)
#Norm_exprMat <- assay(rlogQ3)

rankData <- rankGenes(Norm_exprMat)

scoredf <- simpleScore(rankData, upSet = myeloid.markers_cd64)
new_row <- c("cd64", scoredf$TotalScore)
#cell_singscore <- cbind(cell_singscore, new_row)


scoredf <- cbind(colData(rlogQ3)$Position,scoredf)
scoredf <- scoredf[order(scoredf$`colData(rlogQ3)$Position`),]

barplot(scoredf$TotalScore,
        col = c(rep("orange",2), rep("red",2) , rep("green",4), rep("cyan",6) ,rep("blue",8), rep("pink",2)),
        
        names.arg = c("1_1","2_1","1_2","2_2","1_6","1_9","2_3","2_8","1_3","1_5","1_8","2_12", "2_4", "2_5", "1_10", "1_11", "1_4", "1_7", "2_10", "2_11", "2_6", "2_7", "1_12", "2_9"), cex.names = 0.3
)
grid(nx=NA, ny=NULL)
abline(v = bp+0.6, lty=2, col = "gray")

```


# score CD206- IM
```{r}
myeloid.markers <- read.csv("/home/qiang/Documents/Travail_cell/Travail_V3/Cécilia_project_2/1.2Visualise_feature/myeloids_markers_top20.csv")

myeloid.markers_IM <- myeloid.markers[myeloid.markers$cluster == 0,]$gene


features.scores.use <- GetSignatureScore(dds_Q3, myeloid.markers_IM)
#new_row <- c("CD206- IM", features.scores.use)
#cell_score <- cbind(cell_score, new_row)

visualise_score(features.scores.use)
```

```{r}
rankData <- rankGenes(Norm_exprMat)

scoredf <- simpleScore(rankData, upSet = myeloid.markers_IM)
new_row <- c("CD206- IM", scoredf$TotalScore)
cell_singscore <- cbind(cell_singscore, new_row)

scoredf <- cbind(colData(rlogQ3)$Position,scoredf)
scoredf <- scoredf[order(scoredf$`colData(rlogQ3)$Position`),]

barplot(scoredf$TotalScore,
        col = c(rep("orange",2), rep("red",2) , rep("green",4), rep("cyan",6) ,rep("blue",8), rep("pink",2)),
        
        names.arg = c("1_1","2_1","1_2","2_2","1_6","1_9","2_3","2_8","1_3","1_5","1_8","2_12", "2_4", "2_5", "1_10", "1_11", "1_4", "1_7", "2_10", "2_11", "2_6", "2_7", "1_12", "2_9"), cex.names = 0.3
)
grid(nx=NA, ny=NULL)
abline(v = bp+0.6, lty=2, col = "gray")

```

# score CD206+ IM
```{r}
myeloid.markers <- read.csv("/home/qiang/Documents/Travail_cell/Travail_V3/Cécilia_project_2/1.2Visualise_feature/myeloids_markers_top20.csv")

myeloid.markers_CD206 <- myeloid.markers[myeloid.markers$cluster == 7,]$gene


features.scores.use <- GetSignatureScore(dds_Q3, myeloid.markers_CD206)
new_row <- c("CD206+ IM", features.scores.use)
#cell_score <- cbind(cell_score, new_row)

visualise_score(features.scores.use)
```

```{r}
rankData <- rankGenes(Norm_exprMat)

scoredf <- simpleScore(rankData, upSet = myeloid.markers_CD206)
#new_row <- c("CD206+ IM", scoredf$TotalScore)
#cell_singscore <- cbind(cell_singscore, new_row)

scoredf <- cbind(colData(rlogQ3)$Position,scoredf)
scoredf <- scoredf[order(scoredf$`colData(rlogQ3)$Position`),]

barplot(scoredf$TotalScore,
        col = c(rep("orange",2), rep("red",2) , rep("green",4), rep("cyan",6) ,rep("blue",8), rep("pink",2)),
        
        names.arg = c("1_1","2_1","1_2","2_2","1_6","1_9","2_3","2_8","1_3","1_5","1_8","2_12", "2_4", "2_5", "1_10", "1_11", "1_4", "1_7", "2_10", "2_11", "2_6", "2_7", "1_12", "2_9"), cex.names = 0.3
)
grid(nx=NA, ny=NULL)
abline(v = bp+0.6, lty=2, col = "gray")
```
# write csv file for module score
```{r}
colnames(cell_score) <- cell_score[1,]
cell_score <- cell_score[-1,]

rownames(cell_score) <- colData(dds_Q3)$SegmentDisplayName

#write.csv(cell_score, "cell_score.csv")
```

#write csv file for singscore
```{r}
colnames(cell_singscore) <- cell_singscore[1,]
cell_singscore <- cell_singscore[-1,]

rownames(cell_singscore) <- colnames(Norm_exprMat)

write.csv(cell_singscore, "cell_singscore2.csv")
```


# score Motro vs IM
```{r}
IM.markers <- read.csv("signature/cluster0vsIM.markers.csv")
IM.markers <- IM.markers[order(IM.markers$avg_log2FC, decreasing = T),]
IM.markers <- IM.markers$X[1:20]

# markers absent of expression data : Ly6c2
IM.markers %in% rownames(Norm_exprMat)
IM.markers <- IM.markers[-c(6)]

features.scores.use <- GetSignatureScore(dds_Q3, IM.markers)

# add data to coldata
#df1 <- merge(Moddule_score, colData, by.x = "Sample", by.y = "SegmentDisplayName")

df1 <- colData
new_row <- c("Motro vs IM", features.scores.use)

df1<- cbind(df1, as.vector(features.scores.use))
df1$Module_IMvsMotro <- df1$`as.vector(features.scores.use)`
library(ggpubr)
ggbarplot(df1, x = "Position", y = "Module_IMvsMotro", 
       add = c("mean_se", "jitter")) # point fonctionne aussi à la place de jitter

```
```{r}
rankData <- rankGenes(Norm_exprMat)

scoredf <- simpleScore(rankData, upSet = IM.markers)
new_row <- c("Motro vs IM", scoredf$TotalScore)

scoredf <- cbind(colData(rlogQ3)$Position,scoredf)
scoredf <- scoredf[order(scoredf$`colData(rlogQ3)$Position`),]

df_Singscore <- merge(scoredf, colData, by.x = "row.names", by.y = "SegmentDisplayName")
df_Singscore <- df_Singscore[,-c(8,9,11)]

ggbarplot(df_Singscore, x = "Position", y = "TotalScore", 
       add = c("mean_se", "jitter"))
```


# Annotation
```{r}
annotation_sample <- read_excel("Data_Thomas/Q3 - publication.xlsx", sheet = "SegmentProperties")
Norm_exprMat <- read_excel("Data_Thomas/Q3 - publication.xlsx", sheet = "TargetCountMatrix")

Norm_exprMat <- as.data.frame(Norm_exprMat)
rownames(Norm_exprMat) <- Norm_exprMat$TargetName
Norm_exprMat <- Norm_exprMat[,-1]

```

# Scoring cells ILC2
```{r}
makers_Ilc2 <- read.csv("/home/qiang/Documents/Travail_cell/Travail_V3/Cécilia_project_2/spatial_transcriptomic/signature/ILC2_markers.csv")

makers_Ilc2 <- makers_Ilc2[order(makers_Ilc2$avg_log2FC, decreasing = T),]
Top20_Ilc2 <- makers_Ilc2$X[1:20]

rankData <- rankGenes(Norm_exprMat)

scoredf <- simpleScore(rankData, upSet = Top20_Ilc2)


scoredf <- merge(scoredf, annotation_sample[,c(5,25)], by.x = "row.names", by.y = "SegmentDisplayName")
scoredf <- scoredf[order(scoredf$Group),]

ILC2score <- scoredf[,c(1,3,5)]
write.csv(ILC2score, "score_ILC2.csv")

bp <- barplot(scoredf$TotalScore,
        col = c(rep("green",4), rep("yellow",6) , rep("red",10), rep("cyan",4)),
        
        names.arg = c("1_1","1_2","2_1","2_2", "1_5","2_12","2_4","2_5","2_6","2_7","1_10", "1_11","1_12", "1_3", "1_4", "1_7", "1_8", "2_10", "2_11", "2_9", "1_6","1_9","2_3","2_8"), ylim = c(0,0.3)
)
grid(nx=NA, ny=NULL)
abline(v = bp+0.6, lty=2, col = "gray")

```

```{r}
myeloid.markers <- read.csv("/home/qiang/Documents/Travail_cell/Travail_V3/Cécilia_project_2/spatial_transcriptomic/signature/myeloids_markers_top20.csv")

myeloid.markers_CD206 <- myeloid.markers[myeloid.markers$cluster == 7,]$gene

rankData <- rankGenes(Norm_exprMat)

scoredf <- simpleScore(rankData, upSet = myeloid.markers_CD206)
#new_row <- c("CD206+ IM", scoredf$TotalScore)
#cell_singscore <- cbind(cell_singscore, new_row)

scoredf <- merge(scoredf, annotation_sample[,c(5,25)], by.x = "row.names", by.y = "SegmentDisplayName")
scoredf <- scoredf[order(scoredf$Group),]

bp <- barplot(scoredf$TotalScore,
        col = c(rep("green",4), rep("yellow",5) , rep("red",11), rep("cyan",4)),
        
        names.arg = c("1_1","1_2","2_1","2_2", "1_5","2_12","2_4","2_5","2_6","2_7","1_10", "1_11","1_12", "1_3", "1_4", "1_7", "1_8", "2_10", "2_11", "2_9", "1_6","1_9","2_3","2_8"), ylim = c(0,0.3)
)
grid(nx=NA, ny=NULL)
abline(v = bp+0.6, lty=2, col = "gray")
```



